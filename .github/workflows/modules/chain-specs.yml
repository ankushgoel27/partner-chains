name: Upload chain spec artifacts to Kubernetes 

on:
  workflow_call:
    inputs:
      sha:
        description: 'Commit SHA to append to chain spec secret name'
        required: true
        type: string
      tag:
        description: 'Release Tag'
        required: true
        type: string

jobs:
  chain-specs:
    runs-on: [self-hosted, eks]
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}

      - name: Install kubectl and awscli
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x ./kubectl
          sudo mv ./kubectl /usr/local/bin/kubectl
          sudo apt update && sudo apt install -y awscli

      - name: Configure kubectl
        run: |
          echo "${{ secrets.kubeconfig_base64 }}" | base64 --decode > ${{ runner.temp }}/kubeconfig.yaml
          kubectl config set-cluster my-cluster --server=${{ secrets.K8S_SERVER }} --insecure-skip-tls-verify=true
          kubectl config set-credentials github-actions --token=${{ secrets.K8S_SA_TOKEN }}
          kubectl config set-context my-context --cluster=my-cluster --user=github-actions --namespace=default
          kubectl config use-context my-context

      - name: Download Linux partner-chains-node artifact
        uses: actions/download-artifact@v4
        with:
          name: partner-chains-node-x86_64-linux-artifact-artifact
          path: ./

      - name: Generate Chain Specs
        run: |
          chmod +x ./partner-chains-node
          source ./devnet/.envrc
          ./partner-chains-node build-spec --chain local --disable-default-bootnode --raw > devnet_chain_spec.json
          source ./staging/.envrc
          ./partner-chains-node build-spec --chain staging --disable-default-bootnode --raw > staging_chain_spec.json

      - name: Update Kubernetes secret for devnet chain spec
        run: |
          SHA=${{ inputs.sha }}
          TAG=${{ inputs.tag }}
          SECRET_NAME="devnet-chain-spec-${SHA}-${TAG}"
      
          kubectl delete secret "$SECRET_NAME" --namespace=sc --ignore-not-found
          kubectl create secret generic "$SECRET_NAME" \
            --from-file=devnet_chain_spec.json=./artifacts/devnet_chain_spec.json \
            --namespace=sc
      
      - name: Update Kubernetes secret for staging chain spec
        run: |
          SHA=${{ inputs.sha }}
          TAG=${{ inputs.tag }}
          SECRET_NAME="staging-chain-spec-${SHA}-${TAG}"
      
          kubectl delete secret "$SECRET_NAME" --namespace=staging --ignore-not-found
          kubectl create secret generic "$SECRET_NAME" \
            --from-file=staging_chain_spec.json=./artifacts/staging_chain_spec.json \
            --namespace=staging
        